@model EventManagement.UI.Models.ViewModels.ParticipantViewModel

<div class="modal fade" id="participantModal" tabindex="-1" aria-labelledby="participantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="participantModalLabel">Katılımcılar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="participantLoadingSection">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <p class="mt-2">Katılımcılar yükleniyor...</p>
                    </div>
                </div>

                <div id="participantContentSection" style="display: none;">
                    <ul class="nav nav-tabs" id="participantTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="participant-list-tab" data-bs-toggle="tab" data-bs-target="#participant-list" type="button" role="tab" aria-controls="participant-list" aria-selected="true">Katılımcı Listesi</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="participant-stats-tab" data-bs-toggle="tab" data-bs-target="#participant-stats" type="button" role="tab" aria-controls="participant-stats" aria-selected="false">Katılımcı İstatistikleri</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="add-participant-tab" data-bs-toggle="tab" data-bs-target="#add-participant" type="button" role="tab" aria-controls="add-participant" aria-selected="false">Katılımcı Ekle</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3" id="participantTabsContent">
                        <div class="tab-pane fade show active" id="participant-list" role="tabpanel" aria-labelledby="participant-list-tab">
                            <div class="row mb-3">
                                <div class="col">
                                    <div class="input-group">
                                        <input type="text" id="participantSearchInput" class="form-control" placeholder="Katılımcı ara (Ad, E-posta)">
                                        <button class="btn btn-outline-secondary" type="button" id="participantSearchButton">
                                            <i class="bi bi-search"></i> Ara
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <select id="participantStatusFilter" class="form-select">
                                        <option value="-1">Tüm Katılımcılar</option>
                                        <option value="0">Onaylı</option>
                                        <option value="2">Bekleme Listesi</option>
                                        <option value="1">İptal Edilmiş</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="participantsTable">
                                    <thead>
                                        <tr>
                                            <th>İsim</th>
                                            <th>E-posta</th>
                                            <th>Telefon</th>
                                            <th>Durum</th>
                                            <th>Katıldı</th>
                                            <th>Kayıt Tarihi</th>
                                            <th>İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="participantsTableBody">
                                        <!-- Katılımcı listesi burada yüklenecek -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noParticipantsMessage" class="alert alert-info mt-3" style="display: none;">
                                Bu etkinlik için katılımcı bulunmamaktadır.
                            </div>
                        </div>

                        <div class="tab-pane fade" id="participant-stats" role="tabpanel" aria-labelledby="participant-stats-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">Katılımcı Özeti</div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="fw-bold">Toplam Katılımcı:</label>
                                                <span id="totalAttendees">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <label class="fw-bold">Onaylı Katılımcı:</label>
                                                <span id="confirmedAttendees">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <label class="fw-bold">Bekleme Listesi:</label>
                                                <span id="waitingListAttendees">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <label class="fw-bold">İptal Edilen Katılımcı:</label>
                                                <span id="cancelledAttendees">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">Kapasite Durumu</div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="fw-bold">Maksimum Kapasite:</label>
                                                <span id="maxCapacity">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <label class="fw-bold">Kalan Kapasite:</label>
                                                <span id="availableCapacity">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <label class="fw-bold">Doluluk Oranı:</label>
                                                <span id="fillRate">-</span>
                                            </div>
                                            <div class="progress mt-2">
                                                <div id="capacityProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="add-participant" role="tabpanel" aria-labelledby="add-participant-tab">
                            <form id="addParticipantForm">
                                <input type="hidden" id="eventId" name="EventId" value="">
                                <div class="row mb-3">
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <input type="email" id="emailSearch" class="form-control" placeholder="Katılımcı e-posta adresi ile ara">
                                            <button class="btn btn-outline-primary" type="button" id="searchEmailButton">
                                                <i class="bi bi-search"></i> Ara
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">Daha önce katılım sağlamış katılımcıları e-posta ile arayabilirsiniz.</small>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="name" class="form-label">Ad Soyad <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="Name" required>
                                    <div class="invalid-feedback">Lütfen ad soyad giriniz.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-posta <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="Email" required>
                                    <div class="invalid-feedback">Lütfen geçerli bir e-posta adresi giriniz.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Telefon <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="phone" name="Phone" required>
                                    <div class="invalid-feedback">Lütfen geçerli bir telefon numarası giriniz.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Notlar</label>
                                    <textarea class="form-control" id="notes" name="Notes" rows="3"></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                    <button type="submit" class="btn btn-primary" id="addParticipantButton">Katılımcı Ekle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Katılımcı modalı açıldığında
    $('#participantModal').on('shown.bs.modal', function (e) {
        const button = $(e.relatedTarget);
        const eventId = button.data('event-id');
        
        $('#eventId').val(eventId);
        
        loadParticipants(eventId);
        loadEventStatistics(eventId);
    });
    
    // Katılımcıları yükle
    function loadParticipants(eventId) {
        $('#participantLoadingSection').show();
        $('#participantContentSection').hide();
        
        $.ajax({
            url: `/api/events/${eventId}/attendees`,
            method: 'GET',
            success: function(response) {
                if (response.isSuccess && response.data) {
                    renderParticipants(response.data);
                } else {
                    $('#participantsTableBody').empty();
                    $('#noParticipantsMessage').show();
                }
                
                $('#participantLoadingSection').hide();
                $('#participantContentSection').show();
            },
            error: function(xhr) {
                console.error('Katılımcılar yüklenirken hata oluştu:', xhr);
                toastr.error('Katılımcılar yüklenirken bir hata oluştu.');
                
                $('#participantLoadingSection').hide();
                $('#participantContentSection').show();
                $('#noParticipantsMessage').show();
            }
        });
    }
    
    // Katılımcıları tabloya render et
    function renderParticipants(participants) {
        const tbody = $('#participantsTableBody');
        tbody.empty();
        
        if (participants.length === 0) {
            $('#noParticipantsMessage').show();
            return;
        }
        
        $('#noParticipantsMessage').hide();
        
        participants.forEach(function(p) {
            let statusBadge = '';
            
            if (p.isCancelled) {
                statusBadge = '<span class="badge bg-danger">İptal Edildi</span>';
            } else if (p.status === 0) {
                statusBadge = '<span class="badge bg-success">Onaylandı</span>';
            } else if (p.status === 1) {
                statusBadge = '<span class="badge bg-danger">İptal Edildi</span>';
            } else if (p.status === 2) {
                statusBadge = '<span class="badge bg-warning text-dark">Bekleme Listesi</span>';
            }
            
            const attendedBadge = p.hasAttended 
                ? '<span class="badge bg-success"><i class="bi bi-check-lg"></i></span>' 
                : '<span class="badge bg-secondary"><i class="bi bi-x-lg"></i></span>';
                
            const regDate = new Date(p.registrationDate).toLocaleString();
            
            const row = `
                <tr data-id="${p.id}" data-status="${p.status}" data-cancelled="${p.isCancelled}">
                    <td>${p.name}</td>
                    <td>${p.email}</td>
                    <td>${p.phone || '-'}</td>
                    <td>${statusBadge}</td>
                    <td class="text-center">${attendedBadge}</td>
                    <td>${regDate}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary edit-participant" title="Düzenle">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger delete-participant" title="Sil">
                                <i class="bi bi-trash"></i>
                            </button>
                            ${p.status === 2 && !p.isCancelled ? 
                                `<button class="btn btn-outline-success approve-participant" title="Onayla">
                                    <i class="bi bi-check-lg"></i>
                                </button>` : ''}
                            ${p.status === 0 && !p.isCancelled && !p.hasAttended ? 
                                `<button class="btn btn-outline-success mark-attended" title="Katıldı Olarak İşaretle">
                                    <i class="bi bi-person-check"></i>
                                </button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
            
            tbody.append(row);
        });
        
        // Filtre olayını bağla
        $('#participantStatusFilter').on('change', filterParticipants);
        $('#participantSearchButton').on('click', filterParticipants);
        $('#participantSearchInput').on('keypress', function(e) {
            if (e.which === 13) {
                filterParticipants();
            }
        });
    }
    
    // Katılımcıları filtrele
    function filterParticipants() {
        const statusFilter = parseInt($('#participantStatusFilter').val());
        const searchText = $('#participantSearchInput').val().toLowerCase();
        
        $('#participantsTableBody tr').each(function() {
            const row = $(this);
            const status = parseInt(row.data('status'));
            const isCancelled = row.data('cancelled') === true;
            
            // Durum filtresi
            let statusMatch = true;
            if (statusFilter === 0) {
                statusMatch = status === 0 && !isCancelled;
            } else if (statusFilter === 1) {
                statusMatch = status === 1 || isCancelled;
            } else if (statusFilter === 2) {
                statusMatch = status === 2 && !isCancelled;
            }
            
            // Metin araması
            const name = row.find('td:eq(0)').text().toLowerCase();
            const email = row.find('td:eq(1)').text().toLowerCase();
            const textMatch = searchText === '' || name.includes(searchText) || email.includes(searchText);
            
            // Görünürlüğü ayarla
            row.toggle(statusMatch && textMatch);
        });
        
        checkNoResults();
    }
    
    // Filtrelenmiş sonuçlarda eleman yoksa mesaj göster
    function checkNoResults() {
        const visibleRows = $('#participantsTableBody tr:visible').length;
        
        if (visibleRows === 0) {
            if ($('#participantsTableBody tr').length === 0) {
                $('#noParticipantsMessage').text('Bu etkinlik için katılımcı bulunmamaktadır.');
            } else {
                $('#noParticipantsMessage').text('Arama kriterlerinize uygun katılımcı bulunamadı.');
            }
            $('#noParticipantsMessage').show();
        } else {
            $('#noParticipantsMessage').hide();
        }
    }
    
    // Etkinlik istatistiklerini yükle
    function loadEventStatistics(eventId) {
        $.ajax({
            url: `/api/events/${eventId}/statistics`,
            method: 'GET',
            success: function(response) {
                if (response.isSuccess && response.data) {
                    const stats = response.data;
                    
                    $('#totalAttendees').text(stats.totalAttendees);
                    $('#confirmedAttendees').text(stats.confirmedAttendees);
                    $('#waitingListAttendees').text(stats.waitingListAttendees);
                    $('#cancelledAttendees').text(stats.cancelledAttendees);
                    
                    $('#maxCapacity').text(stats.maxCapacity != null ? stats.maxCapacity : 'Sınırsız');
                    $('#availableCapacity').text(stats.maxCapacity != null ? stats.availableCapacity : 'Sınırsız');
                    $('#fillRate').text(stats.fillRate.toFixed(1) + '%');
                    
                    const progressBar = $('#capacityProgressBar');
                    progressBar.css('width', stats.fillRate + '%');
                    progressBar.text(stats.fillRate.toFixed(1) + '%');
                    
                    if (stats.fillRate < 50) {
                        progressBar.removeClass('bg-warning bg-danger').addClass('bg-success');
                    } else if (stats.fillRate < 80) {
                        progressBar.removeClass('bg-success bg-danger').addClass('bg-warning');
                    } else {
                        progressBar.removeClass('bg-success bg-warning').addClass('bg-danger');
                    }
                }
            },
            error: function(xhr) {
                console.error('İstatistikler yüklenirken hata oluştu:', xhr);
                toastr.error('İstatistikler yüklenirken bir hata oluştu.');
            }
        });
    }
    
    // E-posta ile katılımcı ara
    $('#searchEmailButton').on('click', function() {
        const email = $('#emailSearch').val().trim();
        
        if (!email) {
            toastr.warning('Lütfen aramak için bir e-posta adresi girin.');
            return;
        }
        
        $.ajax({
            url: `/api/events/attendees/search?email=${encodeURIComponent(email)}`,
            method: 'GET',
            success: function(response) {
                if (response.isSuccess && response.data) {
                    const attendee = response.data;
                    
                    // Form alanlarını doldur
                    $('#name').val(attendee.name);
                    $('#email').val(attendee.email);
                    $('#phone').val(attendee.phone);
                    $('#notes').val(attendee.notes);
                    
                    toastr.success('Katılımcı bilgileri bulundu ve form dolduruldu.');
                } else {
                    toastr.info('Bu e-posta adresi ile katılımcı bulunamadı.');
                }
            },
            error: function(xhr) {
                console.error('Katılımcı aranırken hata oluştu:', xhr);
                toastr.error('Katılımcı aranırken bir hata oluştu.');
            }
        });
    });
    
    // Email arama alanında enter tuşu
    $('#emailSearch').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#searchEmailButton').click();
        }
    });
    
    // Katılımcı ekle formu submit
    $('#addParticipantForm').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        if (!form[0].checkValidity()) {
            form.addClass('was-validated');
            return;
        }
        
        const eventId = $('#eventId').val();
        const formData = {
            eventId: eventId,
            name: $('#name').val(),
            email: $('#email').val(),
            phone: $('#phone').val(),
            notes: $('#notes').val()
        };
        
        $('#addParticipantButton').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ekleniyor...');
        
        $.ajax({
            url: `/api/events/${eventId}/attendees`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.isSuccess) {
                    toastr.success(response.message || 'Katılımcı başarıyla eklendi.');
                    
                    // Formu temizle
                    form[0].reset();
                    form.removeClass('was-validated');
                    
                    // Katılımcı listesini ve istatistikleri yenile
                    loadParticipants(eventId);
                    loadEventStatistics(eventId);
                    
                    // Liste sekmesine geç
                    $('#participant-list-tab').tab('show');
                } else {
                    toastr.error(response.message || 'Katılımcı eklenirken bir hata oluştu.');
                }
                
                $('#addParticipantButton').prop('disabled', false).text('Katılımcı Ekle');
            },
            error: function(xhr) {
                console.error('Katılımcı eklenirken hata oluştu:', xhr);
                toastr.error(xhr.responseJSON?.message || 'Katılımcı eklenirken bir hata oluştu.');
                $('#addParticipantButton').prop('disabled', false).text('Katılımcı Ekle');
            }
        });
    });
    
    // Katılımcı silme işlemi
    $(document).on('click', '.delete-participant', function() {
        const row = $(this).closest('tr');
        const id = row.data('id');
        const name = row.find('td:eq(0)').text();
        
        if (confirm(`"${name}" isimli katılımcıyı silmek istediğinize emin misiniz?`)) {
            const eventId = $('#eventId').val();
            
            $.ajax({
                url: `/api/events/attendees/${id}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.isSuccess) {
                        toastr.success('Katılımcı başarıyla silindi.');
                        
                        // Katılımcı listesini ve istatistikleri yenile
                        loadParticipants(eventId);
                        loadEventStatistics(eventId);
                    } else {
                        toastr.error(response.message || 'Katılımcı silinirken bir hata oluştu.');
                    }
                },
                error: function(xhr) {
                    console.error('Katılımcı silinirken hata oluştu:', xhr);
                    toastr.error('Katılımcı silinirken bir hata oluştu.');
                }
            });
        }
    });
    
    // Katılımcı düzenleme modalı için gerekli fonksiyonlar buraya eklenecek
    
</script> 